### 12_04

@PostFilter란?

@PostFilter는 메소드의 리턴값에 대한 필터링을 수행한다.

READY상태 시험지 엿다면 사이즈가 1인 리스트가 내려오는게 맞을 것이다. 
public boolean notPrepareState(Paper paper) {
    return paper.getState() != PaperState.READY;
}
루트 객체에 있는 메소드가 바로 컨트롤 할 수 있을 것 
Paper paper3 = Paper.builder().state(PaperState.READY).build();
Paper paper3 = Paper.builder()
.paperId(3L)
.state(PaperState.READY)
.build();
paperRepository.save(paper3);
List<Paper> papers = paperRepository.findAll();

@PostF스로 ilter("notPrepareState(filterObject)")
똑같이 컨트롤러에서 했던걸 서비스로 내려갔는 데
빈의 생성과 라이프타임에 대한 이슈가 있기 떄문에 안디ㅚ느것이다. 

autowired하는 시점이 cifigureㄹ르 만ㄷ느
PaperService 생성 시점이 너무 빠르다. 그래서 서비스를 감싸느 프록시 = 새=

리스트가 아닌경우 postAuthorize검사를 하고 
자연스럽게 페이퍼를 가져가는 getPaper함수에 대해서 PreAuthorize를 걸어준다.
퍼미션을 복잡하게 줬는데 당연히 이건 postAuthorize로 구현해주는게 더 ㅈㅏ연ㅅ연스럽게 할 수 이싿. 
두 번째와 세번째 테스트가 성공하도록 

user1이 user2의 시험지를 가져가려고 한 상황 
paper 컨트롤러에서 paperService.getPaper(paperId)를 호출하면

post로 이렇게 체크하는게 헤드 퍼미션에서 페이퍼 서비스를 가져와 하는것보다 낫다. 
만약에 이걸 서비스에다 가져간다 하더라도 동작할 것이다. 

@PostAuthorize("returnObject.studentIds.contains(principal.username)")
@GetMapping("/get/{paperId}")


131 + 44 + 6 = 181

CustomVoter 
private final String PREFIX = "SCHOOL_";
ConfiguAttribute PREFIX로 startwith을 하면 우리가 원하는 attribute라고 하자 
school_뒤에 오는 primary role_ primary오는 유저라면 grant를 해준다 .

String role = attributes.stream().filter(attribute -> attr.get)

if(authentication.getAuthorities().stream().filter(auth->auth.getAuthority().equeals("ROLE_"+role.toUpperCase())).count() > 0) {
    return ACCESS_GRANTED;
}
return ACCESS_DENIED;
return List.of(new SecurityConfig(PREFIX + role.toUpperCase()));
paperController에 secured가 없어도 
알아서 잘 찾아온다 
왜냐하면 필터시큐리티가 아니라 메소드 시큐리티쪽에서 
GlobalMethodSecurityConfiguration에서 메소드를 재정의 해줘야되는데 
MethodSecurityMetadataSource를 재정의 해줘야한다.
그래서 이 메소드를 재정의 해줘야한다.

methodsecuritymetadatasource 쪽에서 검사해주는 코드가 들어온다. 

filtersecurity쪽에서는 지나갔는데 두번재 methodsecurityinterceptor쪽에서는 
어노ㅔ이션에 있는 value를 넘겨주는 것이다. 그렇게 해서 

ehcache를 쓰면 메모리에 캐시를 저장할 수 있다.
이전 시간에 테스트했던 페이퍼 객체를 가져와서 간단하게 테스트 하도록 하겠다. 











































